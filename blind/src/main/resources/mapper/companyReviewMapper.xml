<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ksinfo.blind.companyReview.mapper.CompanyReviewMapper">
<select id="companySearch" parameterType="String" resultType="com.ksinfo.blind.companyReview.dto.CompanyDto"> 
 SELECT
	company_id
	,user_id
	,company_name
	,business_type_code
	,company_address
	,founding_date
	,workers_count
	,app_date
	,company_domain
	,company_homepage
	,company_explain
	,verify_flag
	,closing_flag
 FROM
  blind.company_mgt
 WHERE 
  company_name like '%' || #{paramString} || '%'
 AND verify_flag = '1'
 AND closing_flag = '0'
 AND logical_del_flag = '0'  
</select>

<select id="companySearchAll" resultType="com.ksinfo.blind.companyReview.dto.CompanyDto"> 
 SELECT
	company_id
	,user_id
	,company_name
	,business_type_code
	,company_address
	,founding_date
	,workers_count
	,app_date
	,company_domain
	,company_homepage
	,company_explain
	,verify_flag
	,closing_flag
 FROM
  blind.company_mgt

</select>
	
	
	
	
<select id="companySearchPopular" resultType="com.ksinfo.blind.companyReview.dto.CompanyMainViewDto">
SELECT	
	c2.company_id
	,c2.company_name
	,round(avg(c1.all_point),0) as all_point
	,round(avg(c1.all_point),1) as real_all_point 
	
FROM
	blind.company_review_mgt as c1,
	blind.company_mgt as c2
WHERE
	c1.company_id = c2.company_id
AND
    c1.verify_flag = '1'
AND  
    c1.complete_flag = '1'
GROUP BY
	c2.company_id,c2.company_name
	
ORDER BY 
	all_point desc
    fetch first 9 rows only
</select>

<insert id="companyReviewJoin" parameterType="com.ksinfo.blind.companyReview.dto.CompanyJoinDto">
insert into
	blind.company_review_mgt(
		company_review_id
		,user_id
		,company_id
		,job_group_code
		,all_point
		,career_point
		,work_life_balance_point
		,pay_point
		,company_culture_point
		,head_point
		,simple_comment
		,advantages
		,disadvantages
		,resign_reason
		,work_start_date
		,work_end_date
		,work_area
		,verify_flag
		,complete_flag
	    , rec_create_user_id
        , rec_create_date
        , rec_update_user_id
        , rec_update_date
        , logical_del_flag
	
	)values(
		default
		,#{userId}
		,#{companyId}
		,#{jobGroupCode}
		,#{allPoint}
		,#{careerPoint}
		,#{workLifeBalancePoint}
		,#{payPoint}
		,#{companyCulturePoint}
		,#{headPoint}
		,#{simpleComment}
		,#{advantages}
		,#{disadvantages}
		,#{resignReason}
		,#{workStartDate}
		,#{workEndDate}
		,#{workArea}
		,'0'
		,'0'
	    , 1
        , now()
        , 0
        , now()
        , '0'	
	)
</insert>

<select id="getCompanyName" resultType="String" parameterType="int">
	SELECT
		company_name
	FROM
		blind.company_mgt
	where
		company_mgt.company_id = #{companyId}
</select>

<select id="getTotalRecord" resultType="_int">
	SELECT COUNT(*)
	FROM
		blind.post_mgt
	where(
		post_title like '%' || #{companyName} ||  '%'
	or
		post_contents like '%' || #{companyName} ||  '%')
	<if test="searchKeyword neq null">
		and (
			post_title like '%' || #{searchKeyword} ||  '%'

		or
			post_contents like '%' || #{searchKeyword} ||  '%')
	</if>
	AND logical_del_flag = '0'
</select>

<select id="getPosts"  resultType="com.ksinfo.blind.search.dto.PostDto">
SELECT
   post_title --게시글 주제
   ,post_contents --게시글 내용
   ,company_name --작성자가 근무하는 기업명
   ,user_nickname --작성자의 닉네임
   ,(SELECT COUNT(*) FROM blind.post_count_inf AS pci WHERE po.post_id = pci.post_id) AS post_count --글의 조회수
   ,(SELECT COUNT(*) AS recommend_count FROM blind.post_recommend_inf as pri where pri.post_id = po.post_id) AS recommend_count --글의 추천수
   ,(SELECT COUNT(*) AS reply_count FROM blind.reply_mgt as rm where rm.post_id = po.post_id) AS reply_count --글의 댓글수
   ,post_create_date --게시글의 최초작성일
FROM blind.post_mgt as po
   LEFT JOIN blind.user_mgt as us --작성자의 닉네임
      ON po.user_id = us.user_id
      and last_generation_flag = '1'
   LEFT JOIN blind.company_mgt as cm --근무기업명
      ON us.company_id = cm.company_id
where (
   post_title like '%' || #{companyName} || '%'
   or
   post_contents like '%' || #{companyName} || '%')
<if test="searchKeyword neq null">
   and (
   post_title like '%' || #{searchKeyword} || '%'
   or
   post_contents like '%' || #{searchKeyword} || '%')
</if>
   AND po.logical_del_flag = '0'
order by po.post_id DESC;
</select>

</mapper>