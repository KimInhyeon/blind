<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ksinfo.blind.common.mapper.MainMapper">
	<select id="topicBestList" resultType="com.ksinfo.blind.common.dto.CommonPostDto">
		SELECT pm.post_id AS postId
			, bm.board_topic_name AS boardTopicname
			, pm.user_id AS userId
			, pm.post_title AS postTitle
			, pm.post_contents AS postContents
			, pm.post_create_date AS postCreateDate
			, TRIM(TO_CHAR(pci.post_count, '999,999,999,999')) AS postCount
			, TRIM(TO_CHAR(COALESCE(COUNT(pri.post_recommend_flag), 0), '999,999,999,999')) AS recommendCount
			, TRIM(TO_CHAR(COALESCE(COUNT(rm.reply_id), 0), '999,999,999,999')) AS replyCount
		FROM blind.post_mgt pm
			INNER JOIN blind.user_mgt um ON pm.user_id = um.user_id
			INNER JOIN blind.board_mgt bm ON pm.board_id = bm.board_id
			INNER JOIN blind.post_count_inf pci ON pci.post_id = pm.post_id
			LEFT OUTER JOIN blind.post_recommend_inf pri ON pm.post_id = pri.post_id
			LEFT OUTER JOIN blind.reply_mgt rm ON pm.post_id = rm.post_id
		WHERE pm.post_create_date BETWEEN NOW() + INTERVAL '-3 DAY' AND NOW()
		GROUP BY pm.post_id
				, bm.board_topic_name
				, pm.user_id
				, pm.post_title
				, pm.post_contents
				, pm.post_create_date
				, pci.post_count
		ORDER BY pci.post_count DESC
		FETCH FIRST 10 ROWS ONLY;
	</select>

	<select id="topicSubList" resultType="com.ksinfo.blind.common.dto.CommonPostDto">
		SELECT COALESCE(rank.post_id, 0) AS postId
			, rank.board_id AS boardId
			, rank.board_topic_name AS boardTopicname
			, COALESCE(rank.post_title, 'ポストが作成されていません。') AS postTitle
			, rank.post_create_date AS postCreateDate
			, COALESCE(pc.count, 0) AS recordCount
			, TRIM(TO_CHAR(rank.post_count, '999,999,999,999,999')) AS postCount
		FROM (
			SELECT pm.post_id
				, bm.board_id
				, bm.board_topic_name
				, pm.post_title
				, pm.post_create_date
				, pci.post_count
				, RANK() OVER (PARTITION BY pm.board_id ORDER BY pci.post_count DESC) AS rn
			FROM blind.post_mgt pm
				INNER JOIN blind.post_count_inf pci ON pci.post_id = pm.post_id
				RIGHT JOIN blind.board_mgt bm ON pm.board_id = bm.board_id
		) AS rank
			LEFT JOIN (
				SELECT board_id,
					COUNT(*) AS count
				FROM blind.post_mgt
				GROUP BY board_id
			) AS pc ON rank.board_id = pc.board_id
		WHERE rank.rn BETWEEN 1 AND 5
		ORDER BY rank.board_id ASC;
	</select>

	<select id="getDirectoryTotalRecord" parameterType="com.ksinfo.blind.common.dto.DirectorySearchDto"
			resultType="_int">
		SELECT COUNT(*)
		FROM blind.company_mgt
		WHERE
		<choose>
			<when test="isSearchCompanyName">
				<foreach collection="searchKeywordList" item="searchKeyword" open="(" close=")" separator="OR">
					LOWER(search_company_name) LIKE LOWER(#{searchKeyword})
				</foreach>
			</when>
			<otherwise>
				LOWER(company_name) LIKE LOWER(#{searchKeywordList[0]})
			</otherwise>
		</choose>
			AND verify_flag = '1'
			AND logical_del_flag = '0';
	</select>

	<select id="getDirectoryCompanyList" parameterType="com.ksinfo.blind.common.dto.DirectorySearchDto"
			resultType="com.ksinfo.blind.common.vo.DirectoryCompanyVO">
		SELECT company_id AS companyId
			, company_name AS companyName
		FROM blind.company_mgt
		WHERE
		<choose>
			<when test="isSearchCompanyName">
				<foreach collection="searchKeywordList" item="searchKeyword" open="(" close=")" separator="OR">
					LOWER(search_company_name) LIKE LOWER(#{searchKeyword})
				</foreach>
			</when>
			<otherwise>
				LOWER(company_name) LIKE LOWER(#{searchKeywordList[0]})
			</otherwise>
		</choose>
			AND verify_flag = '1'
			AND logical_del_flag = '0'
		ORDER BY search_company_name;
	</select>
</mapper>