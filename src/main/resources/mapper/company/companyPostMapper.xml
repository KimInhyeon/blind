<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ksinfo.blind.company.mapper.CompanyPostMapper">
	<select id="getTotalCompanyPostRecord" parameterType="com.ksinfo.blind.company.dto.CompanyPostSearchDto"
			resultType="_int">
		SELECT COUNT(*)
		FROM blind.post_mgt
		WHERE (
		<choose>
			<when test="searchKeyword eq null">
				LOWER(post_title) LIKE '%' || LOWER(#{companyName}) || '%'
				OR LOWER(post_contents) LIKE '%' || LOWER(#{companyName}) || '%'
			</when>
			<otherwise>
				(LOWER(post_title) LIKE '%' || LOWER(#{companyName}) || '%'
					AND LOWER(post_title) LIKE '%' || LOWER(#{searchKeyword}) || '%'
				) OR (LOWER(post_contents) LIKE '%' || LOWER(#{companyName}) || '%'
					AND LOWER(post_contents) LIKE '%' || LOWER(#{searchKeyword}) || '%'
				)
			</otherwise>
		</choose>
		) AND logical_del_flag = '0';
	</select>

	<select id="getCompanyPostList" parameterType="com.ksinfo.blind.company.dto.CompanyPostSearchDto"
			resultType="com.ksinfo.blind.company.vo.CompanyPostVO">
		SELECT post_id AS postId,
			post_title AS postTitle,
			post_contents AS postContents,
			CASE WHEN us.logical_del_flag = '0' THEN user_nickname ELSE '脱会した会員' END AS userNickname,
			CASE WHEN co.verify_flag = '1' AND co.logical_del_flag = '0' THEN company_id ELSE 0 END AS companyId,
			CASE WHEN co.verify_flag = '1' AND co.logical_del_flag = '0' THEN company_name END As companyName,
			CASE WHEN NOW() - post_create_date > INTERVAL '1 week'
					THEN TO_CHAR(post_create_date, 'MM.DD')
				WHEN NOW() - post_create_date > INTERVAL '2 day'
					THEN EXTRACT(DAYS FROM NOW() - post_create_date) || '日前'
				WHEN NOW() - post_create_date > INTERVAL '1 day'
					THEN '昨日'
				WHEN NOW() - post_create_date > INTERVAL '1 hour'
					THEN EXTRACT(HOURS FROM NOW() - post_create_date) || '時間前'
				WHEN NOW() - post_create_date > INTERVAL '1 minute'
					THEN EXTRACT(MINS FROM NOW() - post_create_date) || '分前'
				ELSE 'だった今'
			END AS postCreateDate,
		post_count AS postCount, (
			SELECT COUNT(*)
			FROM blind.post_recommend_inf
			WHERE post_id = po.post_id
			AND post_recommend_flag = '1'
		) AS postRecommendCount, (
			SELECT COUNT(*)
			FROM blind.reply_mgt
			WHERE post_id = po.post_id
			AND logical_del_flag = '0'
		) AS replyCount,
		<choose>
			<when test="userId gt 0">
				(SELECT EXISTS(
					SELECT
					FROM blind.bookmark_mgt
					WHERE user_id = #{userId}
						AND post_id = po.post_id
						AND logical_del_flag = '0'
				))
			</when>
			<otherwise>FALSE</otherwise>
		</choose> AS bookmarked
		FROM blind.post_mgt AS po
			INNER JOIN blind.post_count_inf USING(post_id)
			INNER JOIN blind.user_mgt AS us
				ON po.user_id = us.user_id AND last_generation_flag = '1'
			INNER JOIN blind.company_mgt AS co USING(company_id)
		WHERE (
	<choose>
		<when test="searchKeyword eq null">
			LOWER(post_title) LIKE '%' || LOWER(#{companyName}) || '%'
				OR LOWER(post_contents) LIKE '%' || #{companyName} || '%'
		</when>
		<otherwise>
			(LOWER(post_title) LIKE '%' || LOWER(#{companyName}) || '%'
				AND LOWER(post_title) LIKE '%' || LOWER(#{searchKeyword}) || '%'
			) OR (LOWER(post_contents) LIKE '%' || LOWER(#{companyName}) || '%'
				AND LOWER(post_contents) LIKE '%' || LOWER(#{searchKeyword}) || '%'
			)
		</otherwise>
	</choose>
		) AND po.logical_del_flag = '0'
		ORDER BY post_id DESC;
	</select>
</mapper>