<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ksinfo.blind.member.mapper.BookmarkMapper">
	<select id="getMyBookmarkList" parameterType="long" resultType="com.ksinfo.blind.member.vo.BookmarkPostVO">
		SELECT po.board_id AS boardId,
			board_topic_name AS boardTopicName,
			bm.post_id AS postId,
			post_title AS postTitle,
			post_contents AS postContents,
			CASE WHEN us.logical_del_flag = '0' THEN company_id ELSE 0 END AS companyId,
			CASE WHEN us.logical_del_flag = '0' THEN company_name END AS companyName,
			CASE WHEN us.logical_del_flag = '0' THEN user_nickname ELSE '脱会した会員' END AS userNickname,
			TO_CHAR(po.rec_create_date, 'MM.DD') AS postCreateDate,
			post_count AS postCount,
			EXISTS(
				SELECT
				FROM blind.post_recommend_inf
				WHERE post_id = bm.post_id
					AND user_id = 146
					AND post_recommend_flag = '1'
			) AS recommended, (
				SELECT COUNT(*)
				FROM blind.post_recommend_inf
				WHERE post_id = bm.post_id
					AND post_recommend_flag = '1'
			) AS postRecommendCount, (
				SELECT COUNT(*)
				FROM blind.reply_mgt
				WHERE post_id = bm.post_id
					AND logical_del_flag = '0'
			) AS replyCount
		FROM blind.bookmark_mgt AS bm
			INNER JOIN blind.post_mgt AS po
				ON bm.post_id = po.post_id AND po.logical_del_flag = '0'
			INNER JOIN blind.board_mgt AS bo
				ON po.board_id = bo.board_id AND closed_flag = '0' AND bo.logical_del_flag = '0'
			INNER JOIN blind.post_count_inf AS pci
				ON bm.post_id = pci.post_id
			INNER JOIN blind.user_mgt AS us
				ON po.user_id = us.user_id AND last_generation_flag = '1'
			INNER JOIN blind.company_mgt USING(company_id)
		WHERE bm.logical_del_flag = '0'
			AND bm.user_id = 146
		ORDER BY bm.rec_create_date DESC
		FETCH FIRST 30 ROWS ONLY;
	</select>

	<select id="searchBookmark" parameterType="com.ksinfo.blind.member.dto.BookmarkDto"
			resultType="com.ksinfo.blind.member.vo.BookmarkVO">
		SELECT bookmark_id AS bookmarkId,
			logical_del_flag AS logicalDelFlag
		FROM blind.bookmark_mgt
		WHERE user_id = #{userId}
			AND post_id = #{postId};
	</select>

	<insert id="addBookmark" parameterType="com.ksinfo.blind.member.dto.BookmarkDto">
		INSERT INTO blind.bookmark_mgt (
			post_id, user_id, bookmark_create_date, bookmark_update_date, rec_create_user_id,
			rec_create_date, rec_update_user_id, rec_update_date, logical_del_flag
		) VALUES (
			#{postId}, #{userId}, NOW(), NOW(), #{userId},
			NOW(), #{userId}, NOW(), '0'
		);
	</insert>

	<update id="updateBookmark">
		UPDATE blind.bookmark_mgt
		SET logical_del_flag = CASE WHEN logical_del_flag = '0' THEN '1' ELSE '0' END,
			bookmark_update_date = NOW(),
			rec_update_user_id = #{userId},
			rec_update_date = NOW()
		WHERE bookmark_id = #{bookmarkId};
	</update>
</mapper>